---
title: "실험계획 실습1"
author: "Minsub Shin"
date: "2024-03-28"
output:
  html_document: default
  pdf_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 예제 3.4
완전확률화설계에 의해 5개의 그룹으로부터 각각 4개의 반복 자료를 얻었다. 그룹 간의 평균치가 유의하게 존재하는지 분석하고자 한다.
$$ H_0: \tau_1=\tau_2=\tau_3=\tau_4=\tau_5\ \ \ \ \ vs\ \ \ \ H_1:\ not\ H_0$$

먼저 주어진 자료를 그룹과 결합하여 자료행렬 sol을 만들자.
```{r data}
group <- c(rep(1,4), rep(2,4), rep(3,4), rep(4,4), rep(5,4))
y<- c(2.4, 2.7, 3.1, 3.1,
      0.7, 1.6, 1.7, 1.8,
      2.4, 3.1, 5.4, 6.1,
      0.3, 0.3, 2.4, 2.7,
      0.5, 0.9, 1.4, 2.0)
sol <- cbind(group,y)
sol
```

이제 범주화된 변수 group을 기준으로 ANOVA를 실시하자.
```{r anova}
group <- as.factor(group)
aov1 <- aov(y~group)
summary(aov1)
```
검정통계량 F=5.966, p-value가 0.00444로 매우 작아 귀무가설을 기각함을 알 수 있다. 즉, 5개의 그룹의 평균은 모두 동일하다고 할 수 없다.
5개 그룹별 boxplot을 그려 시각적으로 확인해 보자.

```{r boxplot}
plot(y~group)
```
또, 각 그룹별 평균값은 tapply() 함수를 이용해 구할 수 있다. 자료를 눈으로 살펴보면 유의한 차이가 존재할 것으로 예상할 수 있다.

```{r groupmean}
tapply(y, group, mean)
```

이제 도입한 ANOVA 모형이 적절한 가정들을 만족하는지에 관한 모형진단(model diagnosis)을 해 보자. 이는 잔차분석(residual analysis)의 과정으로, 아래와 같은 그림을 통해 간단히 확인해볼 수 있다.

```{r residualplot}
par(mfrow=c(2,2))
plot(aov1)
```
(a) 왼쪽 위의 잔차그림(residual plot)은 fitted value에 대해 표준화 잔차를 그린 그림으로, 잔차의 패턴을 볼 수 있다. ANOVA모형의 경우 fitted value는 group mean과 동일하다.
(b) 오른쪽 위의 정규 Q-Q 그림(normal Q-Q plot은 표준정규분포와 실제 표준화 잔차(standardized residual)들의 quantile들을 plot한 그림으로, 자료가 정규분포를 만족할 경우 직선 위에 놓이게 된다. 이 경우 자료가 정규분포에서 크게 벗어나지 않음을 알 수 있다.
(c) 왼쪽 아래의 제곱근 표준화 잔차그림은 fitted value에 대해 $\sqrt{|표준화\ 잔차|}$을 그린 그림으로, 정규분포를 만족하는 경우 95%의 점이 0과 2 사이에 놓이게 된다. 선의 경우 그룹별 잔차 평균을 이은 선으로, 귀무가설을 만족한다면 수평선이 된다.
(d) 오른쪽 아래의 그룹별 표준화 잔차그림은 각 그룹별로 표준화 잔차를 그린 그림으로, 이 경우 본질적으로 (a)의 그림과 차이가 없다.

모형가정 중 등분산성의 경우 bartlett test를 이용해 검정해볼 수 있다.
```{r bartlett}
bartlett.test(y~group)
```
p-value가 0.06677로 귀무가설을 기각하지 못한다. 즉, 5개 그룹의 분산은 동일하다고 할 수 있다.

### 다중비교
Fisher's LSD(least significant difference test), Bonferroni's method, Tukey's HSD 등의 방법론을 이용해 어떤 그룹간 평균의 차가 유의한지에 관한 다중비교를 해 보자.
```{r multicomp1}
tapply(y,group,mean)
pairwise.t.test(y,group,p.adjust="none",pool.sd=TRUE)
```
```{r multicomp2}
pairwise.t.test(y,group,p.adjust="bonferroni",pool.sd=FALSE)
```
Bonferroni의 방법은 LSD보다 훨씬 보수적이어서 통계적으로 유의한 평균 차이를 하나도 찾아내지 못하였다.

```{r multicomp3}
a.tukey <- TukeyHSD(aov1, ordered=TRUE)
a.tukey
plot(a.tukey)
```
0을 포함하지 않는 신뢰구간이 통계적으로 유의한 차이를 의미한다.
이외에도, agricolae 패키지를 이용해서 LSD, HSD, Scheffe, SNK 등의 다양한 방법에 기반한 다중비교를 수행하고 그룹화된 결과까지 얻을 수 있어 소개한다.
```{r agricolae, include=FALSE, echo=FALSE}

library(agricolae)
```

```{r multicomp4}
aov1<-aov(y~group)
LSD.test(aov1, "group", p.adj="none", main="Y of different groups")
HSD.test(aov1, "group", group=TRUE)
scheffe.test(aov1, "group", group=TRUE, main="Y of different groups")
SNK.test(aov1, "group", main="Y of different groups")
```

## 예제 3.5
5개의 그룹에 대한 대비검정을 하고자 한다. 먼저 baseline을 group 1으로 설정하여, 다음과 같은 귀무가설들에 대한 검정을 수행하자.
$$C_2:\ -\mu_1+\mu_2=0 $$
$$C_3:\ -\mu_1+\mu_3=0 $$
$$C_4:\ -\mu_1+\mu_4=0 $$
$$C_5:\ -\mu_1+\mu_5=0 $$
```{r constrast1}
k<-5
control<-1
contr.treatment(k, base=control, contrasts=TRUE)
summary.lm(aov1)
```

또, 직교다항식을 이용한 대비검정은 다음과 같이 수행할 수 있다.
```{r constrast2}
contrasts(group)<-contr.poly(levels(group))
contrasts(group)
round(contrasts(group),digits=2)
summary.lm(aov(y~group))
```

이외에도, 원하는 임의의 대비(contrast)에 대한 검정 역시 수행할 수 있다. 다음과 같은 검정을 수행해 보자.
$$H_0\ :\ \frac{\mu_1+\mu_2+\mu_3}{3}=\frac{\mu_4+\mu_5}{2}$$

```{r constrast3}
k<-5
n<-length(y)
m<-tapply(y,group,mean); m
ni<-tapply(y,group,length); ni
c1<-c(2,2,2,-3,-3)
sum(c1^2/ni)
mse<-1.132
f<-sum(c1*m)^2/(mse*sum(c1^2/ni))
1-pf(f,1,n-k)
```
p 값이 0.0066이 되어 귀무가설을 기각한다.